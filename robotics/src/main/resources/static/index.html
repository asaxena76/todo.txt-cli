<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>DSC10 Robotics</title>

    <script src="robotics/robotics.js"></script>

    <script src="scratch-blocks/blockly_uncompressed_horizontal.js"></script>
    <script src="scratch-blocks/msg/messages.js"></script>
    <script src="scratch-blocks/blocks_common/math.js"></script>
    <script src="scratch-blocks/blocks_common/text.js"></script>
    <script src="scratch-blocks/blocks_horizontal/control.js"></script>
    <script src="scratch-blocks/blocks_horizontal/event.js"></script>
    <script src="scratch-blocks/blocks_horizontal/wedo.js"></script>
    <script src="scratch-blocks/blocks_horizontal/default_toolbox.js"></script>
    <script>
        'use strict';

        var fakeDragStack = [];
        var workspace = null;

        window.addEventListener("message", function(event) {
            // We only accept messages from ourselves
            if (event.source != window)
                return;

            if (event.data.type && (event.data.type == "FROM_CS")) {
                console.log("Page received: " + event.data.text);

                var xml = Blockly.Xml.workspaceToDom(workspace);
                var xmltext = Blockly.Xml.domToPrettyText(xml);
                ivr_outputtext(xmltext);
                var itaelement = document.getElementById("input-text-area");

                        itaelement.value = ivr_outputcode + ivr_code_footer;
                itaelement.focus();
                document.execCommand('SelectAll');
                document.execCommand('Copy');


                window.postMessage({ type: "FROM_PAGE", text: "copyack" }, "*");
                ivr_outputcode=ivr_code_header;
            }
        }, false);

        function start() {
            var soundsEnabled = null;
            if (sessionStorage) {
                // Restore sounds state.
                soundsEnabled = sessionStorage.getItem('soundsEnabled');
                if (soundsEnabled === null) {
                    soundsEnabled = true;
                } else {
                    soundsEnabled = (soundsEnabled === 'true');
                }
            } else {
                soundsEnabled = true;
            }
            setSoundsEnabled(soundsEnabled);

            // Setup blocks
            // Parse the URL arguments.
            var match = location.search.match(/dir=([^&]+)/);
            var rtl = match && match[1] == 'rtl';
            //document.forms.options.elements.dir.selectedIndex = Number(rtl);
            var toolbox = getToolboxElement();
            //document.forms.options.elements.toolbox.selectedIndex =
            //        toolbox ? 1: 0;

            match = location.search.match(/side=([^&]+)/);

            var side = match ? match[1] : 'start';

            //document.forms.options.elements.side.value = side;

            workspace = Blockly.inject('blocklyDiv', {
                comments: false,
                disable: false,
                collapse: false,
                media: 'scratch-blocks/media/',
                readOnly: false,
                rtl: rtl,
                scrollbars: true,
                toolbox: toolbox,
                trashcan: true,
                horizontalLayout: side == 'top' || side == 'bottom',
                toolboxPosition: side == 'top' || side == 'start' ? 'start' : 'end',
                sounds: soundsEnabled,
                grid: {spacing: 16,
                    length: 1,
                    colour: '#2C344A',
                    snap: false
                },
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 4,
                    minScale: 0.25,
                    scaleSpeed: 1.1
                },
                colours: {
                    fieldShadow: 'rgba(255, 255, 255, 0.3)',
                    dragShadowOpacity: 0.6
                }
            });

            if (sessionStorage) {
                // Restore previously displayed text.
                //var text = sessionStorage.getItem('textarea');
                //if (text) {
                    //document.getElementById('importExport').value = text;
                //}
               // taChange();

                // Restore event logging state.
                var state = sessionStorage.getItem('logEvents');
                logEvents(Boolean(state));

                // Restore flyout event logging state.
                state = sessionStorage.getItem('logFlyoutEvents');
                logFlyoutEvents(Boolean(state));
            }
        }

        function getToolboxElement() {
            var match = location.search.match(/toolbox=([^&]+)/);
           // return "toolbox-categories";
            return document.getElementById('toolbox-' + (match ? match[1] : 'categories'));
        }

        function toXml() {
            var output = document.getElementById('importExport');
            var xml = Blockly.Xml.workspaceToDom(workspace);
            output.value = Blockly.Xml.domToPrettyText(xml);
            output.focus();
            output.select();
            taChange();
        }

        function fromXml() {
            var input = document.getElementById('importExport');
            var xml = Blockly.Xml.textToDom(input.value);
            Blockly.Xml.domToWorkspace(workspace, xml);
            taChange();
        }

        // Disable the "Import from XML" button if the XML is invalid.
        // Preserve text between page reloads.
        function taChange() {
            var textarea = document.getElementById('input-text-area');

            var valid = true;
            try {
                if ( textarea.value == 'copy') {
                    var xml = Blockly.Xml.workspaceToDom(workspace);
                    ivr_outputtext(xml);
                    textarea.value=ivr_outputcode;
                }

            } catch (e) {
                valid = false;
            }
            //document.getElementById('import').disabled = !valid;
        }

        function logEvents(state) {
           // var checkbox = document.getElementById('logCheck');
            //checkbox.checked = state;
            if (sessionStorage) {
                sessionStorage.setItem('logEvents', state ? 'checked' : '');
            }
            if (state) {
                workspace.addChangeListener(logger);
            } else {
                workspace.removeChangeListener(logger);
            }
        }

        function logFlyoutEvents(state) {
            //var checkbox = document.getElementById('logFlyoutCheck');
            //checkbox.checked = state;
            if (sessionStorage) {
                sessionStorage.setItem('logFlyoutEvents', state ? 'checked' : '');
            }
            var flyoutWorkspace = (workspace.flyout_) ? workspace.flyout_.workspace_ :
                    workspace.toolbox_.flyout_.workspace_;
            if (state) {
                flyoutWorkspace.addChangeListener(logger);
            } else {
                flyoutWorkspace.removeChangeListener(logger);
            }
        }

        function logger(e) {
            console.log(e);
        }

        function glowBlock() {
            if (Blockly.selected) {
                workspace.glowBlock(Blockly.selected.id, true);
            }
        }

        function unglowBlock() {
            if (Blockly.selected) {
                workspace.glowBlock(Blockly.selected.id, false);
            }
        }

        function glowStack() {
            if (Blockly.selected) {
                workspace.glowStack(Blockly.selected.id, true);
            }
        }

        function unglowStack() {
            if (Blockly.selected) {
                workspace.glowStack(Blockly.selected.id, false);
            }
        }

        function sprinkles(n) {
            var prototypes = [];
            var toolbox = getToolboxElement();
            var blocks = toolbox.getElementsByTagName('block');
            for (var i = 0; i < n; i++) {
                var blockXML = blocks[Math.floor(Math.random() * blocks.length)];
                var block = Blockly.Xml.domToBlock(blockXML, workspace);
                block.initSvg();
                block.moveBy(
                        Math.round(Math.random() * 450 + 40),
                        Math.round(Math.random() * 600 + 40)
                );
            }
        }

        function spaghetti(n) {
            var xml = spaghettiXml;
            for(var i = 0; i < n; i++) {
                xml = xml.replace(/(<(statement|next)( name="SUBSTACK")?>)<\//g,
                        '$1' + spaghettiXml + '</');
            }
            xml = '<xml xmlns="http://www.w3.org/1999/xhtml">' + xml + '</xml>';
            var dom = Blockly.Xml.textToDom(xml);
            console.time('Spaghetti domToWorkspace');
            Blockly.Xml.domToWorkspace(workspace, dom);
            console.timeEnd('Spaghetti domToWorkspace');
        }

        var spaghettiXml = [
            '  <block type="control_repeat">',
            '    <value name="TIMES">',
            '      <shadow type="math_whole_number">',
            '        <field name="NUM">10</field>',
            '      </shadow>',
            '    </value>',
            '    <statement name="SUBSTACK"></statement>',
            '    <next></next>',
            '  </block>'
        ].join('\n');

        function setSoundsEnabled(state) {
           // var checkbox = document.getElementById('soundsEnabled');
            //checkbox.checked = (state) ? 'checked' : '';
            if (sessionStorage) {
                sessionStorage.setItem('soundsEnabled', state);
            }
        }
        function fakeDrag(id, dx, dy, opt_workspace) {
            var ws = opt_workspace || Blockly.getMainWorkspace();
            var blockToDrag = ws.getBlockById(id);

            if (!blockToDrag) {
                fakeDragWrapper();
                return;
            }
            var blockTop = blockToDrag.svgGroup_.getBoundingClientRect().top;
            var blockLeft = blockToDrag.svgGroup_.getBoundingClientRect().left;

            // Click somewhere on the block.
            var mouseDownEvent = new MouseEvent('mousedown',
                    {clientX: blockLeft + 5, clientY: blockTop + 5});
            blockToDrag.onMouseDown_(mouseDownEvent);

            // Throw in a move for good measure.
            setTimeout(
                    function() {
                        var mouseMoveEvent = new MouseEvent('mousemove',
                                {clientX: blockLeft + dx,
                                    clientY: blockTop + dy});
                        blockToDrag.onMouseMove_(mouseMoveEvent);

                        // Drop at dx, dy.
                        setTimeout(
                                function() {
                                    var mouseUpEvent = new MouseEvent('mouseup',
                                            {clientX: blockLeft + dx,
                                                clientY: blockTop + dy});
                                    blockToDrag.onMouseUp_(mouseUpEvent);

                                    setTimeout(fakeDragWrapper(), 100);
                                }, 30);
                    }, 30);
        };

        function fakeDragWrapper() {
            var dragInfo = fakeDragStack.pop();
            if (dragInfo) {
                fakeDrag(dragInfo.id, dragInfo.dx, dragInfo.dy, dragInfo.workspace);
            }
        }

        function fakeManyDrags() {
            var blockList = workspace.getAllBlocks();
            for (var i = 0; i < 2 * blockList.length; i++) {
                fakeDragStack.push(
                        {
                            id: blockList[Math.round(Math.random() * (blockList.length - 1))].id,
                            // Move some blocks up and to the left, but mostly down and to the right.
                            dx: Math.round((Math.random() - 0.25) * 200),
                            dy: Math.round((Math.random() - 0.25) * 200),
                            workspace: workspace
                        });
            }
            fakeDragWrapper();
        }
    </script>

    <style>
        html, body {
            height: 100%;
        }

        body {
            background-color: #fff;
            font-family: sans-serif;
            overflow: hidden;
        }

        h1 {
            font-weight: normal;
            font-size: 140%;
        }

        #blocklyDiv {
            float: right;
            height: 95%;
            width: 100%;
        }

        #collaborators {
            float: right;
            width: 30px;
            margin-left: 10px;
        }

        #collaborators > img {
            margin-right: 5px;
            height: 30px;
            padding-bottom: 5px;
            width: 30px;
            border-radius: 3px;
        }

        #importExport {
            font-family: monospace;
        }
    </style>
</head>

<body onload="start()">
<div id="collaborators"></div>
<div id="blocklyDiv"></div>

<textarea rows="4" cols="50" id="input-text-area"   onchange="taChange()">
    int led = 13;void setup(){pinMode(led, OUTPUT);}void loop(){digitalWrite(led, HIGH);delay(100);digitalWrite(led, LOW); delay(100);}
</textarea>

</body>
</html>
